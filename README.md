# Factorio Annealer
  The Factorio annealer is a program that generates a cost optimized layout of blocks for a factory given a set of items to be produced.  Cost optimization is performed using a common place and route techinue called simulated annealing.  Simply put, a random move is generated and is conditionally accepted based on a given cost function.  After a large number of moves, the design is considered optimized.  A blueprint is then generated by this layout that can be directly ported into Factorio.  Sets of sub items can be partitioned and all ingredients will be dedicated to make those items.  
  This idea has been floating around in my head for some years now, but I hadn't found a good use case for it until recently.  The main issue with this design initially was using large city blocks basically trivialized product generation.  Meaning a single block could potentially generate all the needed product for a very large (i.e. 1k science/min) base.  This made the problem of annealing a small number of large blocks not very interesting and could probably be done manually.  It wasn't until a few months ago, I saw a post on the Factorio subreddit about a city block implementation that was smaller than the typical chunk aligned one.  This got me thinking about how small could I make the city blocks and if simulated annealing could be applied here.  This was what finally got me to start this journey of creating 57 block blueprints and writing this annealer.  Additionally, shortly after starting writing the program, redruin made an Alt-F4 post about his project to programmatically generate blueprints called Factorio Draftsman.  This was very fortuitous because it would save me the trouble of writing a program that imported a blueprint book, stitched hundreds (>200k total entities) of them together and then converted it back to a blueprint string to be imported into Factorio.  

## Factory Components
  The factory generates an item list and recipe list from vanilla game data by parsing the corresponding Lua files from the official `factorio-data` repository.  This is not a robust method, but learning to load all game data into Lua first and then extracting recipes and items from there was not something I wanted to do.  If this were to be implemented, the annealer could extend to include mods and their items and recipes.  In addition to vanilla items and recipes, some custom items and recipes are added to allow for the algorithm to work properly.  For example, a special `labs` recipe is created to handle the research and takes in all of the science packs as inputs with no outputs.  Each relevant recipe was implemented in game and stored as a `FactoryBlockTemplate`.  The templates specify required ingredients, products produced and at what rate along with some physical information regarding the placement of the train stations.  
  
## Micro City Blocks
  The factory blueprint is enabled by a library of custom cells I've coined as Micro City Blocks (MCB).  These are minimum sized train-based blocks that will allow 2 1-1 train stations (1 on top, 1 on bottom).  All in all, each cell is 36x32 tiles in size.  Due to the small size of each block and the desire to pack these as close together as possible, intersections were implemented without left turns.  Therefore, in order to turn left, a train must go straight and make 3 rights.  While this may be a bit longer distance wise, having left turns within the intersection would make it so any train entering the intersection block all other trains trying to enter the same intersection.  Meaning, a train going straight would block a train going the opposite direction.  This issue outweighed the need for left turns.  The train scheduling is done using the Logistic Train Network (LTN) mod to minimize the number of trains running at any given moment.  There are a total of 57 defined blocks, one for each recipe within the research recipe tree and a few auxiliary blueprints for LTN and resource interfaces at the edge of the factory.  This set can be extended to implement any item's recipe tree, but the current blueprint book contains on those related to the vanilla science packs.  
  
## Annealer

## Blueprinting
  As mentioned in the introduction, the ability to export the design into a valid Factorio blueprint was made possible using Factorio Draftsman and the imported MCB blueprint book.  Factorio Draftsman is an extremely powerful tool.  It allows the user to create a blueprint and add entities or modify existing entities within a programming environment.  If you visit the Alt-F4 page about it, you'll see a number of examples of what can be done with this tool including creating map images, ROM for a computer, preloaded turrets, etc.  If you've ever had a Factorio related idea that needs a blueprint created, Factorio Draftsman will fulfill all your needs. 
  After my shameless plug for Factorio Draftsman, back to the program at hand.  After importing the MCB blueprint book, each one is placed inside of a custom `factorio-draftsman` `Group` object.  Doing so allows the entities within a single blueprint to be handled all at once with minimal overhead.  When adding a `Group` to a `Blueprint`, draftsman makes a `deepcopy` of the `Group`, including each entity and any circuit connections and filters.  When adding the same block multiple times, this lets you simply set the position of one block, add it to the blueprint and then set the position for the next block without having worry about the first block's position being modified.  
  
